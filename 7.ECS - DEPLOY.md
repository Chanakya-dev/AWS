# üö¢ Notes on ECS (Elastic Container Service) & ECR (Elastic Container Registry)

---

## üìå PART 1: What is Amazon ECS?

### ‚û§ ECS (Elastic Container Service) is:

A **fully managed container orchestration service** by AWS that allows you to:

* Run and manage **Docker containers**
* Automatically handle **scheduling**, **scaling**, **load balancing**
* Run containers on either:

  * **EC2 instances** (your own virtual machines)
  * **AWS Fargate** (serverless ‚Äî you don‚Äôt manage infrastructure)

---

## üß± Core ECS Concepts (Building Blocks)

### 1Ô∏è‚É£ Cluster

* A logical grouping of resources (like EC2 or Fargate).
* You deploy services and tasks **into a cluster**.
* You can have multiple ECS clusters (e.g., staging, production).

---

### 2Ô∏è‚É£ Task Definition

* The **blueprint** for your container application.
* It defines:

  * Docker image to use
  * CPU and memory requirements
  * Networking mode
  * Port mappings
  * Environment variables
  * Volumes
  * IAM roles
* JSON-formatted or configured via Console.

> Think of it like the `docker-compose.yaml` file but for ECS.

---

### 3Ô∏è‚É£ Task

* A running container instance that uses a task definition.
* Example: If your task definition has an NGINX container, a task runs that container with the specified config.

---

### 4Ô∏è‚É£ Service

* Manages the **number of running tasks**.
* Can auto-replace failed containers.
* Supports **load balancing** and **auto scaling**.
* Ensures high availability.

---

### 5Ô∏è‚É£ Container Agent

* Installed on EC2 to communicate with ECS backend (not needed in Fargate).
* Registers instance to ECS cluster.

---

### 6Ô∏è‚É£ Launch Types

| Launch Type | Description                                     |
| ----------- | ----------------------------------------------- |
| **EC2**     | You manage the infrastructure (EC2 VMs)         |
| **Fargate** | AWS manages infra, you focus only on containers |

---

## üîÅ ECS Workflow Overview

```
Docker App ‚Üí Build Image ‚Üí Push to ECR ‚Üí Create Task Definition ‚Üí Run Task/Service ‚Üí ECS Cluster ‚Üí (Optional) Load Balancer
```

---

## üì¶ What is Amazon ECR?

### ‚û§ Amazon ECR (Elastic Container Registry):

A **fully managed Docker image registry**, used to:

* Store private container images
* Integrate with ECS, EKS, CodePipeline, etc.
* Replace Docker Hub (no rate limits or downtime)

### Benefits:

* Secure with IAM-based access
* Integrated with ECS and CodeBuild
* Supports **image scanning** for vulnerabilities
* Lifecycle policies for automatic cleanup

---

## üõ† ECS with EC2 (Manual Infrastructure) ‚Äì Setup Guide

### Step 1: Create an ECS Cluster (EC2 Launch Type)

* Go to ECS ‚Üí Create Cluster ‚Üí Choose ‚ÄúEC2 + Networking‚Äù
* Set:

  * Instance type (e.g., `t2.micro`)
  * Number of instances
  * Key pair for SSH
  * VPC/Subnets/Security Group

---

### Step 2: Install Docker and ECS Agent (if custom EC2)

```bash
sudo yum update -y
sudo amazon-linux-extras enable docker
sudo yum install docker -y
sudo service docker start
sudo usermod -a -G docker ec2-user
```

---

### Step 3: Build and Push Docker Image to ECR

1. **Create an ECR Repository**

```bash
aws ecr create-repository --repository-name my-app
```

2. **Authenticate Docker to ECR**

```bash
aws ecr get-login-password | docker login --username AWS --password-stdin <aws_account>.dkr.ecr.<region>.amazonaws.com
```

3. **Tag and Push Image**

```bash
docker tag my-app:latest <aws_account>.dkr.ecr.<region>.amazonaws.com/my-app
docker push <aws_account>.dkr.ecr.<region>.amazonaws.com/my-app
```

---

### Step 4: Create Task Definition

* Go to ECS ‚Üí Task Definitions ‚Üí Create
* Choose EC2 or Fargate
* Add:

  * Container Name
  * Image URL from ECR
  * Memory/CPU
  * Port mapping (80:80)
  * Logging (CloudWatch)

---

### Step 5: Create ECS Service

* Go to ECS ‚Üí Your Cluster ‚Üí Create Service
* Select:

  * Task Definition
  * Number of replicas
  * Load Balancer (if needed)

---

### Step 6: Access the Application

* If using ALB, get DNS of ALB
* If no LB, use public IP of EC2

---

## üöÄ ECS with Fargate (Serverless Containers)

### Benefits:

* No EC2 management
* Pay per task
* Ideal for microservices

### Steps:

1. Create Fargate-compatible Task Definition
2. Create ECS Cluster (Network only)
3. Define Service with Fargate launch type
4. Select VPC and private/public subnets
5. Deploy & monitor

---

## üîê IAM Roles Required

| Role Name                         | Purpose                                        |
| --------------------------------- | ---------------------------------------------- |
| **ecsTaskExecutionRole**          | Allows ECS to pull image from ECR, write logs  |
| **ECS Service Linked Role**       | Needed for ECS service actions                 |
| **Container IAM Role (optional)** | Attach to task to allow access to S3, DynamoDB |

IAM Policy for execution role:

```json
{
  "Effect": "Allow",
  "Action": [
    "ecr:GetAuthorizationToken",
    "ecr:BatchGetImage",
    "logs:CreateLogStream",
    "logs:PutLogEvents"
  ],
  "Resource": "*"
}
```

---

## üß™ Sample Dockerfile

```Dockerfile
FROM node:18
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

---

## üì° Load Balancing in ECS

### Use ALB (Application Load Balancer) with ECS Service:

* Automatically routes traffic to healthy tasks
* Can be used for:

  * Blue/Green deployments
  * Path-based routing (e.g., `/api`, `/admin`)

---

## üìà Auto Scaling in ECS

* Set **TargetTrackingPolicy** to scale tasks based on CPU/memory
* Example:

  * Min Tasks: 2
  * Max Tasks: 10
  * Target CPU: 70%

---

## üß∞ ECS with CI/CD (CodePipeline)

Pipeline Example:

1. **Source**: GitHub or CodeCommit
2. **Build**: CodeBuild (build image, push to ECR)
3. **Deploy**: ECS Deploy Action (updates ECS service)

---

## üß† ECS Use Cases

| Use Case              | ECS Advantage                |
| --------------------- | ---------------------------- |
| Microservices         | Easy scaling of each service |
| Web apps              | Load-balanced containers     |
| Batch jobs            | Run-once tasks               |
| CI/CD workloads       | Seamless build & deploy      |
| Serverless containers | Use Fargate                  |

---

## üìä Monitoring Tools

* **CloudWatch Logs** ‚Äì Application logs
* **CloudWatch Alarms** ‚Äì Trigger scale in/out
* **ECS Console** ‚Äì Task/service status
* **AWS X-Ray** ‚Äì Distributed tracing

---

## ‚úÖ Summary: ECS vs ECR

| Feature      | ECS                          | ECR                          |
| ------------ | ---------------------------- | ---------------------------- |
| Purpose      | Orchestration for containers | Storage for container images |
| Launch Types | EC2 / Fargate                | N/A                          |
| Scaling      | Manual / Auto scaling        | N/A                          |
| IAM Required | Yes (task execution role)    | Yes (for pulling images)     |
| Logging      | CloudWatch integration       | N/A                          |
